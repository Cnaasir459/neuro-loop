---
---

<div class="relative">
  <div class="relative">
    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
    </svg>
    <input 
      type="text" 
      id="search-input"
      placeholder="Search videos..." 
      class="w-full bg-card border border-card rounded-xl pl-12 pr-4 py-3 text-text placeholder-muted focus:outline-none focus:border-primary transition-colors"
    />
  </div>
  <div id="search-results" class="absolute top-full left-0 right-0 mt-2 bg-card border border-card rounded-xl shadow-xl hidden z-50 max-h-96 overflow-y-auto"></div>
</div>

<script>
  async function initSearch() {
    const input = document.getElementById('search-input') as HTMLInputElement;
    const results = document.getElementById('search-results');
    
    if (!input || !results) return;

    input.addEventListener('focus', async () => {
      if (!results.classList.contains('loaded')) {
        results.classList.add('loaded');
        try {
          const response = await fetch('/pagefind/pagefind.json');
          if (response.ok) {
            // Load Pagefind browser script dynamically via a script tag so
            // Astro/Vite doesn't need to resolve /pagefind/pagefind.js at build time.
            const script = document.createElement('script');
            script.src = '/pagefind/pagefind.js';
            script.async = true;
            script.onload = () => {
              // pagefind.js usually attaches a global `window.pagefind`
              console.log('Pagefind script loaded');
            };
            script.onerror = () => {
              console.log('Pagefind script not available');
            };
            document.body.appendChild(script);
          }
        } catch (e) {
          console.log('Search index not yet available');
        }
      }
    });

    input.addEventListener('input', async (e) => {
      const query = (e.target as HTMLInputElement).value;
      
      if (!query || !window.pagefind) {
        results.classList.add('hidden');
        return;
      }

      try {
        const search = await window.pagefind.search(query);
        const results_data = await Promise.all(
          search.results.slice(0, 5).map(r => r.data())
        );
        
        if (results_data.length > 0) {
          results.innerHTML = results_data.map(item => `
            <a href="${item.url}" class="block p-4 hover:bg-darker border-b border-card last:border-0">
              <h4 class="font-medium text-text">${item.meta.title}</h4>
              <p class="text-sm text-muted mt-1 line-clamp-2">${item.excerpt}</p>
            </a>
          `).join('');
          results.classList.remove('hidden');
        } else {
          results.innerHTML = '<div class="p-4 text-muted text-center">No results found</div>';
          results.classList.remove('hidden');
        }
      } catch (e) {
        results.classList.add('hidden');
      }
    });

    document.addEventListener('click', (e) => {
      if (!input.contains(e.target as Node) && !results.contains(e.target as Node)) {
        results.classList.add('hidden');
      }
    });
  }

  initSearch();
</script>
